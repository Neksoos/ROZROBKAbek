# src/services/npc_defs.py
from __future__ import annotations

from dataclasses import dataclass, field
from typing import Dict, List, Optional, Sequence, Set, Tuple, Literal

# ──────────────────────────────────────────────────────────────────────
# Моделі та типи
# ──────────────────────────────────────────────────────────────────────


@dataclass(frozen=True)
class SpawnRules:
    """
    Правила появи NPC:
    - base_chance: базова імовірність показати «кнопку зустрічі» при будь-якому рендері екрана (0..1).
    - cooldown_sec: локальний КД між появами для конкретного гравця.
    - areas_allow / areas_deny: ключі екранів/локацій (наприклад: 'city', 'areas', 'tavern', 'zastava', 'battle_result').
    - time_windows: список інтервалів годин доби [(start_h, end_h)].
    - lvl_min/lvl_max: рівневі обмеження для гравця.
    """
    base_chance: float = 0.05
    cooldown_sec: int = 900
    areas_allow: Optional[Set[str]] = None
    areas_deny: Optional[Set[str]] = None
    time_windows: Optional[List[Tuple[int, int]]] = None
    lvl_min: int = 1
    lvl_max: int = 999

    def to_dict(self) -> Dict:
        return {
            "base_chance": self.base_chance,
            "cooldown_sec": self.cooldown_sec,
            "areas_allow": sorted(self.areas_allow) if self.areas_allow else None,
            "areas_deny": sorted(self.areas_deny) if self.areas_deny else None,
            "time_windows": self.time_windows[:] if self.time_windows else None,
            "lvl_min": self.lvl_min,
            "lvl_max": self.lvl_max,
        }


@dataclass(frozen=True)
class NpcSpeech:
    """
    Шаблони фраз (тільки говір цього NPC).
    У квестах теж тримаємся цього говору.
    """
    greet: Sequence[str] = ()
    offer: Sequence[str] = ()
    accept: Sequence[str] = ()
    reject: Sequence[str] = ()
    complete: Sequence[str] = ()
    smalltalk: Sequence[str] = ()

    def to_dict(self) -> Dict:
        return {
            "greet": list(self.greet),
            "offer": list(self.offer),
            "accept": list(self.accept),
            "reject": list(self.reject),
            "complete": list(self.complete),
            "smalltalk": list(self.smalltalk),
        }


# ── Мінімальний каркас квестів (без наповнення — додамо пізніше) ──
StageKey = Literal["intro", "q1", "q2", "q3", "done"]


@dataclass(frozen=True)
class QuestStage:
    key: StageKey
    line: str                   # репліка NPC (його говір)
    design_note: str = ""       # підказка для логіки/дизайну (гравцю не показ.)
    requires_items: List[str] = field(default_factory=list)
    grants_items: List[str] = field(default_factory=list)

    def to_dict(self) -> Dict:
        return {
            "key": self.key,
            "line": self.line,
            "design_note": self.design_note,
            "requires_items": list(self.requires_items),
            "grants_items": list(self.grants_items),
        }


@dataclass(frozen=True)
class QuestDef:
    quest_id: str
    name: str
    stages: List[QuestStage]

    def to_dict(self) -> Dict:
        return {
            "quest_id": self.quest_id,
            "name": self.name,
            "stages": [s.to_dict() for s in self.stages],
        }


@dataclass(frozen=True)
class NpcDef:
    key: str
    name: str
    region: str                         # регіон
    accent_notes: str                   # опис говору/манери
    role: str = "quest_giver"
    spawn: SpawnRules = field(default_factory=SpawnRules)
    speech: NpcSpeech = field(default_factory=NpcSpeech)
    # квести цього NPC (залишаємо порожнім — заповнимо наступним кроком)
    quests: List[QuestDef] = field(default_factory=list)
    # прапорець: усі тексти квестів лише говіром персонажа
    dialect_only: bool = True
    # базові параметри для майбутніх генераторів:
    tags: Set[str] = field(default_factory=set)        # теми (spiritual, travel, craft, combat…)
    weight: int = 1                                    # вага у випадковому виборі

    def to_dict(self) -> Dict:
        return {
            "key": self.key,
            "name": self.name,
            "region": self.region,
            "accent_notes": self.accent_notes,
            "role": self.role,
            "spawn": self.spawn.to_dict(),
            "speech": self.speech.to_dict(),
            "quests": [q.to_dict() for q in self.quests],
            "dialect_only": self.dialect_only,
            "tags": sorted(self.tags),
            "weight": self.weight,
        }


# ──────────────────────────────────────────────────────────────────────
# NPC (5 штук з регіональним колоритом)
# ──────────────────────────────────────────────────────────────────────

# 1) ОКСАНА — полтавський м’який говор
OKSANA = NpcDef(
    key="berehynia_oksana",
    name="Берегиня Оксана",
    region="Полтавщина",
    accent_notes="Лагідна, співуча полтавська манера; «шо», м’які приголосні.",
    spawn=SpawnRules(
        base_chance=0.06,
        cooldown_sec=1200,
        areas_allow={"city", "tavern", "zastava", "areas"},
        areas_deny=None,
        time_windows=None,
        lvl_min=1,
        lvl_max=999,
    ),
    speech=NpcSpeech(
        greet=(
            "Ой, дєтко, засвіти свічку в серці — і ніч уже не така страшна.",
            "Шо стоїш, як пеньок у тумані? Йди-но ближче, я тебе добром прикрию.",
            "Та не мерзни, дитино, під вітром. Ставай під моє слово — зігріє.",
            "Еге ж, бачу по очах: дорога тебе притомила. Сідай, віддихни хвильку.",
            "Світло тебе знайшло, дєтко. Значить, не все так темно, як здається.",
            "Тихше будь, ніч слухає. А ми з тобою потихеньку порадимось.",
        ),
        offer=(
            "Потреба є: свічі та віск не родяться з повітря. Дістанеш — освятимо шлях твій.",
            "Он там, по болотах, вогні блукають. Принеси їх жар у мою лампадку — і темрява відступе.",
            "Є старий оберіг, та струхлявів без людської руки. Знайдеш чисті трави й нитку червону — заново його сплетемо.",
            "Чуєш, як вітер виє? То душі непоховані кличуть. Збери їм по дрібці землі з курганів — хай знайдуть спокій.",
            "Треба мені воску й краплю місячної роси. Без того не вдержу світло над селом.",
            "Іди між люди: пошукай того, хто в біді. Приведи його слово до мене — разом витягнемо з темряви.",
        ),
        accept=(
            "Добре робиш, дєтко. Світло любить хоробрих, а хоробрих мало.",
            "От і славно. Я вже чую, як ніч трохи відступає.",
            "Бачиш, не дарма тебе дорога до мене привела. Іди, я молитвою підтримаю.",
            "Так от, отак воно й робиться: один крок — і світла в світі більше.",
        ),
        reject=(
            "Не силуй себе. Та тільки знай: темрява не жде, поки ти надумаєш.",
            "Як серце не лежить — не будемо рвати. Але пам’ятай, дєтко, шанс не завжди вертається.",
            "Та й так буває. Коли страх сильніший — свічка сама не займеться.",
        ),
        complete=(
            "Світло стало теплішим. Бачиш? Дорога вже ясніша під ногами.",
            "Ох, дитино, добре ти справився. Душі заспокоїлись, аж тихіше стало.",
            "Свічки горять рівно, без чорного диму. Значить, твої руки чисті.",
            "От тепер і ти світлом трохи став. Неси його, але не розтринькай.",
        ),
        smalltalk=(
            "Хто світить іншим — у того й самому тепліше, запам’ятай.",
            "Не всі, хто в тумані, вороги. Інколи то просто заблудлі, їм слова доброго треба.",
            "Шо там у тебе на серці? Не носи довго камінь, бо йти важко буде.",
            "Буває ніч чорніша, ніж треба. Але й на неї світанок знаходиться.",
            "Коли не знаєш, куди йти, йди туди, де тепліше людям від тебе.",
        ),
    ),
    quests=[],
    tags={"spiritual", "gathering"},
    weight=2,
)

# 2) СЕМЕН — подільський, сумно-іронічний лірник
SEMEN = NpcDef(
    key="lirnyk_semen",
    name="Сліпий лірник Семен",
    region="Поділля",
    accent_notes="Подільський говор: «ґ», «вуйку», архаїзми, сумно-іронічний тон.",
    spawn=SpawnRules(
        base_chance=0.05,
        cooldown_sec=900,
        areas_allow={"tavern", "city", "areas"},
        areas_deny={"battle"},
        time_windows=[(17, 24), (0, 2)],
        lvl_min=3,
        lvl_max=999,
    ),
    speech=NpcSpeech(
        greet=(
            "Ґей, вуйку, не лякайся — то струни мої тремтять, не душа твоя.",
            "Та йду я, на дотик світ міряю, а ти тут стоїш, як знак питання.",
            "О, чую кроки — певно, ще один герой, шо думає, що смерть його не знайде.",
            "Сідай ближче, вуйку. Я хоч і сліпий, але людей по подиху бачу.",
            "Не ховай монет, я їх не бачу. Мені іншу плату треба — трохи відваги.",
        ),
        offer=(
            "Є звір лютий, шо голос мій крав. Виведи його на чисте — верну пісню людям.",
            "По ярах темних ходить тінь безіменна. Скинь її в безодню, шоб балади знов сміли співатись.",
            "Десь у шинку пропала стара лірна кобза. Вернеш її — зіграю тобі так, шо й біса просльозиться.",
            "Он там, при шляху, розбійник завівся. Я про нього пісню вже маю, лиш кінцівку нема — дороби її мечем.",
            "Мені треба кілька голосів із ночі: принесеш мені трофеї з трьох різних потвор — складу з них думу.",
        ),
        accept=(
            "От і добре. Слава не любить ледачих, вуйку.",
            "Та то діло праведне. Нехай пісня голосніше лунає, ніж виття нечисті.",
            "О, буде про кого співати — не про тих панів пузатих, а про тебе.",
        ),
        reject=(
            "Еге ж, дорога вільна. Тільки пісня без тебе буде тихіша.",
            "Ну, як не нині, то, може, й ніколи. Лихо чекати не любить.",
            "Бачу, серце твоє ще не дозріло до балади. Не біда, дозріє або зогниє.",
        ),
        complete=(
            "Оце пісня! Чуєш, як поле відгукується? Спасибі тобі, вуйку.",
            "Тепер і звір мовчить, і струни співають. Гарно ти крапку поставив.",
            "Буду співать про тебе, поки горлянка не зірветься. Не всім така честь падає.",
        ),
        smalltalk=(
            "Лихо не ходить самє — завше в парі з дурнем. Бережи голову.",
            "У пана кишені повні, а душа порожня. В тебе навпаки — то ще не найгірше.",
            "Старі рани не болять, вуйку, коли є нові. Не набирай зайвих.",
            "Коли смієшся над смертю, вона сердиться, але відступає на крок.",
            "Я сліпий, а все одно бачу, як цей світ кривиться від страху.",
        ),
    ),
    quests=[],
    tags={"music", "hunt"},
    weight=1,
)

# 3) ПАНАС — північне Полісся, комічний недочаклун
PANAS = NpcDef(
    key="nedochaklun_panas",
    name="Недочаклун Панас",
    region="Полісся (Житомирщина)",
    accent_notes="Північне «йой», «шо ж», уривчаста мова, добродушна незграбність.",
    spawn=SpawnRules(
        base_chance=0.07,
        cooldown_sec=600,
        areas_allow={"city", "areas", "workshop", "tavern"},
        areas_deny=None,
        time_windows=None,
        lvl_min=1,
        lvl_max=20,
    ),
    speech=NpcSpeech(
        greet=(
            "Йой, та я ж тільки трохи зачаклував — а воно бухнуло!",
            "О, своїй! Стій обережно, не наступи на ото… е-е, пізно.",
            "Шо ж воно робиться, я одне зілля мішаю, а виходить зовсім інше.",
            "Йой, не лякайся того диму, він… ну, майже не токсичний.",
            "Підійди ближче, але не дуже. Я сам не знаю, де тут безпечне місце.",
        ),
        offer=(
            "Шо ж ти, допоможи зілля назбирати — бо без нього знов бахне.",
            "Треба ряска, треба мох, і трішки ночви… тобто, нічви… ну ти поняв.",
            "Он там, у нетрях, росте така квітка, шо сама себе боїться. Принесеш пару — будем мати чим гасить вибухи.",
            "Я хотів зробить амулет від невдачі, а зробив, походу, її джерело. Збери мені чистих кристалів, переробим.",
            "Принеси з болота трохи багна, але такого, шоб не шипіло. Мо, тоді котел перестане кричати.",
        ),
        accept=(
            "От спасибі, бо я вже дриґаюся від того диму.",
            "Йой, от тепер, може, хоч половина не вибухне.",
            "Добре, шо ти є, бо без тебе я б уже втретє себе в жабу перетворив.",
        ),
        reject=(
            "Та й так піде… певно… якось… ой, ліпше не треба.",
            "Ну, не хочеш — то й не треба. Тільки як почуєш гуркіт — то то я.",
            "Я розумію, страшнувато. Мені теж, якщо чесно.",
        ),
        complete=(
            "О! Не бахкає! Ти маг майже як я… тобто краще.",
            "Видиш, навіть котел перестав стогнати. Значить, живі будем.",
            "Йой, яке гарне зілля вийшло. Поки що нічого не вибухнуло — це вже успіх!",
        ),
        smalltalk=(
            "Йой, от би медовухи — для стабілізації закляття! Ну і нервів.",
            "Якшо шось раптом засвітиться зеленим — не чіпай, то експеримент.",
            "Кажуть, справжній маг нічого не боїться. Значить, я ще вчуся.",
            "Я раз хотів мітлу зачаклувать, шоб літати, а вона від образи згоріла.",
            "Ти, коли що, пам’ятай: як дим став фіолетовий — біжи.",
        ),
    ),
    quests=[],
    tags={"alchemy", "gathering", "comic"},
    weight=3,
)

# 4) НАСТЯ — одесько-південний торгаш-аферист
NASTIA = NpcDef(
    key="nastia_salt_belly",
    name="Настя Солоний Киш",
    region="Одещина",
    accent_notes="Південна швидка мова з дотепом; легкий «одеський» прикус.",
    spawn=SpawnRules(
        base_chance=0.06,
        cooldown_sec=800,
        areas_allow={"market", "city", "tavern", "areas"},
        areas_deny=None,
        time_windows=None,
        lvl_min=5,
        lvl_max=999,
    ),
    speech=NpcSpeech(
        greet=(
            "Сонечко, маю ділову пропозицію — без лоха і життя не те.",
            "Зайди-зайди, не бійся, я кусаюсь тільки цінами.",
            "О, яке миле личко! Прямо кричить: «зроби зі мною вигідну угоду».",
            "Ти дивись, який герой забрів. Прямо ходяча інвестиція.",
            "Не соромся, я своїх клієнтів рідко обманюю. Майже.",
        ),
        offer=(
            "Тягнем бочку через перевал — накладні мої, прибуток твій. Як шось — я не при дєлах.",
            "Є клієнт, любить гостре. Принесеш спецій — я зроблю тобі ціну як родичу.",
            "Треба провести пару мішків так, шоб митники нічого не поняли. Ти ж у нас непомітний, правда?",
            "Он там, у нетрях, ходять дуже переконливі аргументи з зубами. Прибери кількох — бізнесу стане спокійніше.",
            "Принеси мені рідкісну сіль із чорного болота. Продамо як «еліксир мужності», поділим чесно… ну майже.",
        ),
        accept=(
            "Ну от, нормальний бізнес-план! Пішли, поки не роздумав.",
            "От люблю людей, шо вміють ризикувати чужим життям. Жартую. Трохи.",
            "Домовились, сонечко. Я вже в голові прибуток рахую.",
        ),
        reject=(
            "Не шото — твоя воля. Тільки потім не шкодуй.",
            "Добре, будеш чесним бідним, а не хитрим багатим — теж варіант.",
            "Якщо передумаєш — я десь тут, між прибутком і авантюрою.",
        ),
        complete=(
            "Красота! Ти шо, профі? Я в захваті, чесне слово.",
            "Бачиш, як воно працює: ти ризикуєш, я рахую гроші — усі щасливі.",
            "Оце я розумію доставка. Навіть без трупів по дорозі… чи я просто не чула?",
        ),
        smalltalk=(
            "Не нервуйся. Нерви псують шкіру, а шкіра — товарний вигляд.",
            "В наш час довіряти можна тільки собі. І то з обережністю.",
            "Якщо хтось каже «угода століття» — то або бреше, або я.",
            "Головне в бізнесі — виглядати так, ніби ти всіх переіграв, навіть коли все горить.",
            "Люблю чесних людей: з ними так легко працювати… на себе.",
        ),
    ),
    quests=[],
    tags={"trade", "escort", "spices"},
    weight=2,
)

# 5) ЮРКО — емоційний галицький рекрут
YURKO = NpcDef(
    key="yurko_rekrut",
    name="Юрко-Рекрут",
    region="Галичина",
    accent_notes="Емоційний галицький говор: «йой», «шо ти мені розказуєш».",
    spawn=SpawnRules(
        base_chance=0.05,
        cooldown_sec=1000,
        areas_allow={"zastava", "arena", "areas", "city"},
        areas_deny=None,
        time_windows=None,
        lvl_min=2,
        lvl_max=999,
    ),
    speech=NpcSpeech(
        greet=(
            "Та йой! Ти якраз мені треба! Шо, підемо в бійку чи як?",
            "Слава Ісу, живий воїн зайшов, а не тільки тіки писарі.",
            "О, файний вигляд маєш. Видно, шо мечем махати вмієш, а не язиком лиш.",
            "Підходь ближче, не кусаюсь. Хіба шо ворогів.",
            "Та не стій, як стовп. Ходім, покажу, де справжня забава — на полі бою.",
        ),
        offer=(
            "Є тренувальний виїзд. Треба скинути пару голів… у сенсі — страхів.",
            "Збери мені пару трофеїв — покажемо, шо ми з нашої застави не лякаємось!",
            "Там за лісом така нечисть завелась, шо аж пси в селі матюкаються. Розберемось?",
            "Командир каже, треба перевірити новачків. Я скажу, ти зі мною підеш — і всьо ясно стане.",
            "Принесеш декілька відрубаних пазурів та зубів — буде, шо на стіні повісити для настрою.",
        ),
        accept=(
            "От то файно! Мамо моя, буде що згадати!",
            "Так, оце я розумію, воїн, а не подушка диванна.",
            "Домовлено. Як вернемось живі — куплю тобі кухоль чогось міцного.",
        ),
        reject=(
            "Ей, не крут носом. Як надумаєш — гукай.",
            "То ти, може, ще не розігрівся. Але довго не тяни, війна чекати не буде.",
            "Добре, лиш не кажи потім, шо тебе ніхто ніде не кликав.",
        ),
        complete=(
            "Оце робота! Видиш? Дух є! Далі буде ще ліпше.",
            "Та ти, я бачу, не просто так меч носиш. Командир зрадіє.",
            "Файно погуляли, га? І ти живий, і вони вже ні — ідеальний баланс.",
        ),
        smalltalk=(
            "Я вчора три рази меч поламав — і шо? Не здаємось!",
            "Краще вмерти в бою, ніж з нудьги на варті. Але поки шо не вмираємо, ясно?",
            "Якшо страшно — то добре. Страх тримає голову прикрученою.",
            "Наша застава мала, але гонору більше, ніж у півцарства.",
            "Коли чуєш сурму — не думай, біжи. Думати будем після перемоги.",
        ),
    ),
    quests=[],
    tags={"combat", "training"},
    weight=2,
)

# ──────────────────────────────────────────────────────────────────────
# Реєстр + утиліти
# ──────────────────────────────────────────────────────────────────────

REGISTRY_VERSION = 1  # інкремент, якщо мінятимемо структуру

ALL_NPCS: List[NpcDef] = [OKSANA, SEMEN, PANAS, NASTIA, YURKO]
NPCS_BY_KEY: Dict[str, NpcDef] = {n.key: n for n in ALL_NPCS}


def get_npc(key: str) -> Optional[NpcDef]:
    return NPCS_BY_KEY.get(key)


def all_npcs() -> Sequence[NpcDef]:
    return tuple(ALL_NPCS)


def serialize_all() -> List[Dict]:
    """Готово для JSON-відповіді FastAPI."""
    return [n.to_dict() for n in ALL_NPCS]


def serialize_one(key: str) -> Optional[Dict]:
    n = NPCS_BY_KEY.get(key)
    return n.to_dict() if n else None


__all__ = [
    "SpawnRules",
    "NpcSpeech",
    "QuestStage",
    "QuestDef",
    "NpcDef",
    "REGISTRY_VERSION",
    "ALL_NPCS",
    "NPCS_BY_KEY",
    "get_npc",
    "all_npcs",
    "serialize_all",
    "serialize_one",
]